<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Big Agents Studio</title>
    <!-- Supabase UMD v2 -->
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container nav-container">
            <div class="logo">
                <span class="logo-ba">BA</span>
                <div class="logo-text">
                    <span class="logo-big">BIG AGENTS</span>
                    <span class="logo-studio">STUDIO</span>
                </div>
            </div>
            <ul class="nav-menu" id="navMenu">
                <li><a href="admin-dashboard.html" class="active">Dashboard</a></li>
                <li><a href="#" onclick="logout()">Cerrar Sesi√≥n</a></li>
            </ul>
            <div class="hamburger" id="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <div class="dashboard-container" id="adminDashboard">
        <div class="dashboard-header">
            <h1>Panel de Administraci√≥n</h1>
            <p style="color: var(--text-gray);">Gestiona solicitudes de empresas y administra accesos</p>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px;">
            <div style="background: var(--secondary-dark); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px;">
                <div style="color: var(--text-gray); font-size: 14px; margin-bottom: 10px;">Solicitudes Pendientes</div>
                <div id="contadorPendientes" style="font-size: 32px; font-weight: 700; color: var(--accent-orange);">-</div>
            </div>
            <div style="background: var(--secondary-dark); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px;">
                <div style="color: var(--text-gray); font-size: 14px; margin-bottom: 10px;">Empresas Activas</div>
                <div id="contadorActivas" style="font-size: 32px; font-weight: 700; color: #4ade80;">-</div>
            </div>
            <div style="background: var(--secondary-dark); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px;">
                <div style="color: var(--text-gray); font-size: 14px; margin-bottom: 10px;">Agentes Desplegados</div>
                <div style="font-size: 32px; font-weight: 700; color: var(--accent-cyan);">28</div>
            </div>
            <div style="background: var(--secondary-dark); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px;">
                <div style="color: var(--text-gray); font-size: 14px; margin-bottom: 10px;">Ingresos Mensual</div>
                <div style="font-size: 32px; font-weight: 700; color: var(--text-white);">‚Ç¨15.6K</div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h3>Solicitudes Pendientes de Aprobaci√≥n</h3>
                <div id="pendingRequests">
                    <p class="loading">Cargando...</p>
                </div>
            </div>

            <div class="dashboard-card">
                <h3>Empresas Registradas</h3>
                <div id="companiesList">
                    <p class="loading">Cargando...</p>
                </div>
            </div>
        </div>

        <div class="dashboard-card" style="margin-top: 30px;">
            <h3>Cat√°logo de Agentes Disponibles</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center;">
                    <div style="font-size: 40px; margin-bottom: 10px;">ü§ñ</div>
                    <h4>Atenci√≥n al Cliente</h4>
                    <p style="color: var(--text-gray); font-size: 13px; margin-top: 8px;">Soporte 24/7 automatizado</p>
                </div>
                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center;">
                    <div style="font-size: 40px; margin-bottom: 10px;">üìä</div>
                    <h4>An√°lisis de Datos</h4>
                    <p style="color: var(--text-gray); font-size: 13px; margin-top: 8px;">Reportes autom√°ticos</p>
                </div>
                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center;">
                    <div style="font-size: 40px; margin-bottom: 10px;">üìù</div>
                    <h4>Redacci√≥n</h4>
                    <p style="color: var(--text-gray); font-size: 13px; margin-top: 8px;">Generaci√≥n de contenido</p>
                </div>
                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center;">
                    <div style="font-size: 40px; margin-bottom: 10px;">üíº</div>
                    <h4>Gesti√≥n RRHH</h4>
                    <p style="color: var(--text-gray); font-size: 13px; margin-top: 8px;">Automatizaci√≥n RRHH</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2024 Big Agents Studio. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <script>
    async function cargarPanel() {
        const pendientesEl = document.getElementById('pendingRequests');
        const listaEl = document.getElementById('companiesList');
        const contadorPendientes = document.getElementById('contadorPendientes');
        const contadorActivas = document.getElementById('contadorActivas');

        pendientesEl.innerHTML = '<p class="loading">Cargando...</p>';
        listaEl.innerHTML = '<p class="loading">Cargando...</p>';

        try {
            const client = window.supabaseClient || window.supabase;
            if (!client) {
                throw new Error('Supabase no est√° inicializado');
            }

            const { data: empresas, error } = await client
                .from('empresas')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) throw error;

            // Usamos 'estado' para los contadores
            const pendientes = empresas.filter(e => e.estado === 'pendiente');
            const activas = empresas.filter(e => e.estado === 'aprobada');

            contadorPendientes.textContent = pendientes.length;
            contadorActivas.textContent = activas.length;

            // --- Solicitudes Pendientes ---
            if (!pendientes.length) {
                pendientesEl.innerHTML = '<p style="color: var(--text-gray); padding: 20px; text-align: center;">No hay solicitudes pendientes.</p>';
            } else {
                pendientesEl.innerHTML = '';
                pendientes.forEach(e => {
                    const card = document.createElement('div');
                    card.style.cssText = 'background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin-bottom: 15px;';

                    card.innerHTML = `
                    <h4 style="margin: 0 0 10px 0; color: var(--text-white);">${e.nombre_empresa}</h4>
                    <p style="margin: 5px 0; color: var(--text-gray); font-size: 14px; line-height: 1.6;">
                        <strong>CIF:</strong> ${e.cif}<br>
                        <strong>Contacto:</strong> ${e.nombre_contacto} (${e.cargo_contacto})<br>
                        <strong>Email:</strong> ${e.email}<br>
                        <strong>Tel√©fono:</strong> ${e.telefono}<br>
                        <strong>Industria:</strong> ${e.industria} | <strong>Tama√±o:</strong> ${e.tamano}<br>
                        <strong>Presupuesto:</strong> ${e.presupuesto}<br>
                        ${e.sitio_web ? `<strong>Web:</strong> <a href="${e.sitio_web}" target="_blank" style="color: var(--accent-cyan);">${e.sitio_web}</a><br>` : ''}
                        <strong>Necesidades:</strong> ${e.necesidades}
                    </p>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn-aprobar" data-user-id="${e.user_id}" style="background: #4ade80; color: #000; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                            ‚úì Aprobar
                        </button>
                        <button class="btn-rechazar" data-user-id="${e.user_id}" style="background: #ef4444; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                            ‚úó Rechazar
                        </button>
                    </div>
                    `;
                    pendientesEl.appendChild(card);
                });

                document.querySelectorAll('.btn-aprobar').forEach(btn => {
                    btn.addEventListener('click', () => aprobarEmpresa(btn.dataset.userId));
                });
                document.querySelectorAll('.btn-rechazar').forEach(btn => {
                    btn.addEventListener('click', () => rechazarEmpresa(btn.dataset.userId));
                });
            }

            // --- Todas las empresas ---
            if (!empresas.length) {
                listaEl.innerHTML = '<p style="color: var(--text-gray); padding: 20px; text-align: center;">A√∫n no hay empresas registradas.</p>';
            } else {
                listaEl.innerHTML = empresas.map(e => `
                    <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0 0 8px 0; color: var(--text-white);">${e.nombre_empresa}</h4>
                                <p style="margin: 0; color: var(--text-gray); font-size: 13px;">
                                    ${e.email} ‚Äî ${e.nombre_contacto}
                                </p>
                            </div>
                            <span style="color: ${
                                e.estado === 'aprobada'
                                    ? '#4ade80'
                                    : e.estado === 'rechazada'
                                        ? '#ef4444'
                                        : '#fbbf24'
                            }; font-weight: 600; font-size: 14px;">
                                ${
                                    e.estado === 'aprobada'
                                        ? '‚úì Aprobada'
                                        : e.estado === 'rechazada'
                                            ? '‚úó Rechazada'
                                            : '‚è≥ Pendiente'
                                }
                            </span>
                        </div>
                    </div>
                `).join('');
            }

        } catch (error) {
            console.error('Error al cargar panel:', error);
            pendientesEl.innerHTML = '<p style="color: #ef4444; padding: 20px; text-align: center;">Error al cargar solicitudes: ' + error.message + '</p>';
            listaEl.innerHTML = '<p style="color: #ef4444; padding: 20px; text-align: center;">Error al cargar empresas.</p>';
        }
    }

    async function aprobarEmpresa(userId) {
        if (!confirm('¬øAprobar esta empresa? Podr√° acceder a su panel.')) return;

        try {
            const client = window.supabaseClient || window.supabase;
            if (!client) throw new Error('Supabase no est√° inicializado');

            const { error } = await client
                .from('empresas')
                .update({ estado: 'aprobada', aprobado: true })
                .eq('user_id', userId);

            if (error) throw error;

            alert('Empresa aprobada correctamente');
            await cargarPanel();
        } catch (error) {
            console.error('Error al aprobar:', error);
            alert('Error al aprobar empresa: ' + error.message);
        }
    }

    async function rechazarEmpresa(userId) {
        if (!confirm('¬øRechazar esta empresa? Se marcar√° como rechazada.')) return;

        try {
            const client = window.supabaseClient || window.supabase;
            if (!client) throw new Error('Supabase no est√° inicializado');

            const { error } = await client
                .from('empresas')
                .update({ estado: 'rechazada', aprobado: false })
                .eq('user_id', userId);

            if (error) throw error;

            alert('Empresa rechazada');
            await cargarPanel();
        } catch (error) {
            console.error('Error al rechazar:', error);
            alert('Error al rechazar empresa: ' + error.message);
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(cargarPanel, 500);
        });
    } else {
        setTimeout(cargarPanel, 500);
    }
    </script>

    <script src="js/main.js"></script>
</body>
</html>