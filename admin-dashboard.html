<script>
// Ya tienes supabase cargado desde main.js que se carga después

async function cargarPanel() {
    const pendientesEl = document.getElementById('pendingRequests');
    const listaEl = document.getElementById('companiesList');
    const contadorPendientes = document.getElementById('contadorPendientes');
    const contadorActivas = document.getElementById('contadorActivas');

    pendientesEl.innerHTML = '<p class="loading">Cargando...</p>';
    listaEl.innerHTML = '<p class="loading">Cargando...</p>';

    try {
        // Esperar a que supabase esté disponible desde main.js
        if (typeof supabase === 'undefined') {
            throw new Error('Supabase no está inicializado');
        }

        const { data: empresas, error } = await supabase
            .from('empresas')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) throw error;

        const pendientes = empresas.filter(e => !e.aprobado);
        const activas = empresas.filter(e => e.aprobado);

        // Actualizar contadores
        contadorPendientes.textContent = pendientes.length;
        contadorActivas.textContent = activas.length;

        // Pintar solicitudes pendientes
        if (!pendientes.length) {
            pendientesEl.innerHTML = '<p style="color: var(--text-gray); padding: 20px; text-align: center;">No hay solicitudes pendientes.</p>';
        } else {
            pendientesEl.innerHTML = '';
            pendientes.forEach(e => {
                const card = document.createElement('div');
                card.style.cssText = 'background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin-bottom: 15px;';
                
                card.innerHTML = `
                    <h4 style="margin: 0 0 10px 0; color: var(--text-white);">${e.nombre_empresa}</h4>
                    <p style="margin: 5px 0; color: var(--text-gray); font-size: 14px; line-height: 1.6;">
                        <strong>CIF:</strong> ${e.cif}<br>
                        <strong>Contacto:</strong> ${e.nombre_contacto} (${e.cargo_contacto})<br>
                        <strong>Email:</strong> ${e.email}<br>
                        <strong>Teléfono:</strong> ${e.telefono}<br>
                        <strong>Industria:</strong> ${e.industria} | <strong>Tamaño:</strong> ${e.tamano}<br>
                        <strong>Presupuesto:</strong> ${e.presupuesto}<br>
                        ${e.sitio_web ? `<strong>Web:</strong> <a href="${e.sitio_web}" target="_blank" style="color: var(--accent-cyan);">${e.sitio_web}</a><br>` : ''}
                        <strong>Necesidades:</strong> ${e.necesidades}
                    </p>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn-aprobar" data-id="${e.id}" style="background: #4ade80; color: #000; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                            ✓ Aprobar
                        </button>
                        <button class="btn-rechazar" data-id="${e.id}" style="background: #ef4444; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                            ✗ Rechazar
                        </button>
                    </div>
                `;
                
                pendientesEl.appendChild(card);
            });

            // Añadir event listeners a los botones
            document.querySelectorAll('.btn-aprobar').forEach(btn => {
                btn.addEventListener('click', () => aprobarEmpresa(btn.dataset.id));
            });
            document.querySelectorAll('.btn-rechazar').forEach(btn => {
                btn.addEventListener('click', () => rechazarEmpresa(btn.dataset.id));
            });
        }

        // Pintar todas las empresas registradas
        if (!empresas.length) {
            listaEl.innerHTML = '<p style="color: var(--text-gray); padding: 20px; text-align: center;">Aún no hay empresas registradas.</p>';
        } else {
            listaEl.innerHTML = empresas.map(e => `
                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0 0 8px 0; color: var(--text-white);">${e.nombre_empresa}</h4>
                            <p style="margin: 0; color: var(--text-gray); font-size: 13px;">
                                ${e.email} — ${e.nombre_contacto}
                            </p>
                        </div>
                        <span style="color: ${e.aprobado ? '#4ade80' : '#fbbf24'}; font-weight: 600; font-size: 14px;">
                            ${e.aprobado ? '✓ Aprobada' : '⏳ Pendiente'}
                        </span>
                    </div>
                </div>
            `).join('');
        }

    } catch (error) {
        console.error('Error al cargar panel:', error);
        pendientesEl.innerHTML = '<p style="color: #ef4444; padding: 20px; text-align: center;">Error al cargar solicitudes: ' + error.message + '</p>';
        listaEl.innerHTML = '<p style="color: #ef4444; padding: 20px; text-align: center;">Error al cargar empresas.</p>';
    }
}

async function aprobarEmpresa(id) {
    if (!confirm('¿Aprobar esta empresa? Podrá acceder a su panel.')) return;

    try {
        const { error } = await supabase
            .from('empresas')
            .update({ aprobado: true })
            .eq('id', id);

        if (error) throw error;

        if (typeof showNotification === 'function') {
            showNotification('Empresa aprobada correctamente', 'success');
        } else {
            alert('Empresa aprobada correctamente');
        }
        cargarPanel();
    } catch (error) {
        console.error('Error al aprobar:', error);
        if (typeof showNotification === 'function') {
            showNotification('Error al aprobar empresa: ' + error.message, 'error');
        } else {
            alert('Error al aprobar empresa: ' + error.message);
        }
    }
}

async function rechazarEmpresa(id) {
    if (!confirm('¿Rechazar esta empresa? Se eliminará del registro permanentemente.')) return;

    try {
        const { error } = await supabase
            .from('empresas')
            .delete()
            .eq('id', id);

        if (error) throw error;

        if (typeof showNotification === 'function') {
            showNotification('Empresa rechazada y eliminada', 'success');
        } else {
            alert('Empresa rechazada y eliminada');
        }
        cargarPanel();
    } catch (error) {
        console.error('Error al rechazar:', error);
        if (typeof showNotification === 'function') {
            showNotification('Error al rechazar empresa: ' + error.message, 'error');
        } else {
            alert('Error al rechazar empresa: ' + error.message);
        }
    }
}

// Cargar panel cuando el DOM esté listo y supabase inicializado
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(cargarPanel, 500); // Pequeño delay para asegurar que main.js cargó supabase
    });
} else {
    setTimeout(cargarPanel, 500);
}
</script>

<script src="js/main.js"></script>